{% extends "base_template.html" %}

{% block title %}{{ report.title }} - {{ company_name }}{% endblock %}

{% block content %}
<div class="audit-report">
    <!-- Cover Page -->
    <section class="cover-page">
        <div class="cover-content">
            <h1 class="report-title">{{ report.title }}</h1>
            {% if report.subtitle %}
            <h2 class="report-subtitle">{{ report.subtitle }}</h2>
            {% endif %}
            
            <div class="report-metadata">
                <table class="metadata-table">
                    <tr>
                        <th>Report ID:</th>
                        <td>{{ report.report_id }}</td>
                    </tr>
                    <tr>
                        <th>Generated:</th>
                        <td>{{ report.generated_date }}</td>
                    </tr>
                    <tr>
                        <th>Period:</th>
                        <td>{{ report.period }}</td>
                    </tr>
                    <tr>
                        <th>Scope:</th>
                        <td>{{ report.scope }}</td>
                    </tr>
                    <tr>
                        <th>Generated By:</th>
                        <td>{{ report.generated_by }}</td>
                    </tr>
                    {% if report.tenant %}
                    <tr>
                        <th>Tenant:</th>
                        <td>{{ report.tenant.name }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            
            {% if report.confidential %}
            <div class="confidential-banner">
                <i class="fas fa-shield-alt"></i>
                <span>CONFIDENTIAL - RESTRICTED ACCESS</span>
            </div>
            {% endif %}
        </div>
    </section>
    
    <!-- Table of Contents -->
    <section class="toc-section">
        <h2><i class="fas fa-list"></i> Table of Contents</h2>
        <nav class="toc-nav">
            <ul>
                <li><a href="#executive-summary">Executive Summary</a></li>
                <li><a href="#findings-summary">Findings Summary</a></li>
                <li><a href="#detailed-findings">Detailed Findings</a></li>
                {% if report.recommendations %}
                <li><a href="#recommendations">Recommendations</a></li>
                {% endif %}
                {% if report.appendix %}
                <li><a href="#appendix">Appendix</a></li>
                {% endif %}
            </ul>
        </nav>
    </section>
    
    <!-- Executive Summary -->
    <section id="executive-summary" class="executive-summary">
        <h2><i class="fas fa-chart-line"></i> Executive Summary</h2>
        
        {% if report.executive_summary %}
        <div class="summary-text">
            {{ report.executive_summary }}
        </div>
        {% endif %}
        
        {% if report.metrics %}
        <div class="key-metrics">
            <h3>Key Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card total">
                    <div class="metric-label">Total Findings</div>
                    <div class="metric-value">{{ report.metrics.total_findings }}</div>
                </div>
                <div class="metric-card critical">
                    <div class="metric-label">Critical</div>
                    <div class="metric-value">{{ report.metrics.critical }}</div>
                </div>
                <div class="metric-card high">
                    <div class="metric-label">High</div>
                    <div class="metric-value">{{ report.metrics.high }}</div>
                </div>
                <div class="metric-card medium">
                    <div class="metric-label">Medium</div>
                    <div class="metric-value">{{ report.metrics.medium }}</div>
                </div>
                <div class="metric-card low">
                    <div class="metric-label">Low</div>
                    <div class="metric-value">{{ report.metrics.low }}</div>
                </div>
                {% if report.metrics.risk_score %}
                <div class="metric-card risk-score">
                    <div class="metric-label">Risk Score</div>
                    <div class="metric-value">{{ report.metrics.risk_score }}/10</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if report.top_findings %}
        <div class="top-findings">
            <h3>Top Findings</h3>
            <div class="findings-list">
                {% for finding in report.top_findings[:5] %}
                <div class="finding-card {{ finding.severity|lower }}">
                    <div class="finding-header">
                        <span class="finding-number">{{ loop.index }}.</span>
                        <h4>{{ finding.title }}</h4>
                        <span class="severity-badge {{ finding.severity|lower }}">{{ finding.severity }}</span>
                    </div>
                    <p class="finding-description">{{ finding.description }}</p>
                    <div class="finding-meta">
                        <span><i class="fas fa-cogs"></i> {{ finding.rule_name }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>
    
    <!-- Findings Summary -->
    <section id="findings-summary" class="findings-summary">
        <h2><i class="fas fa-search"></i> Findings Summary</h2>
        
        {% if report.metrics %}
        <div class="charts-container">
            <div class="chart-card">
                <h3>Findings by Severity</h3>
                <canvas id="severityChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Findings Over Time</h3>
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
        
        <div class="severity-breakdown">
            <h3>Detailed Breakdown</h3>
            <div class="breakdown-grid">
                {% for severity, count in {
                    'critical': report.metrics.critical,
                    'high': report.metrics.high,
                    'medium': report.metrics.medium,
                    'low': report.metrics.low,
                }.items() if count > 0 %}
                <div class="breakdown-item {{ severity }}">
                    <div class="breakdown-label">{{ severity|title }}</div>
                    <div class="breakdown-value">{{ count }}</div>
                    <div class="breakdown-bar">
                        <div class="bar-fill {{ severity }}" 
                             style="width: {{ (count / report.metrics.total_findings * 100)|round(1) }}%;">
                        </div>
                    </div>
                    <div class="breakdown-percentage">
                        {{ (count / report.metrics.total_findings * 100)|round(1) }}%
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>
    
    <!-- Detailed Findings -->
    <section id="detailed-findings" class="detailed-findings">
        <h2><i class="fas fa-file-alt"></i> Detailed Findings</h2>
        
        <div class="findings-controls">
            <div class="filter-controls">
                <label for="severityFilter">Filter by Severity:</label>
                <select id="severityFilter" class="form-control">
                    <option value="all">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="search-controls">
                <input type="text" id="findingSearch" class="form-control" placeholder="Search findings...">
                <button id="clearSearch" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="findings-container">
            {% for finding in report.findings %}
            <div class="finding-detail-card {{ finding.severity|lower }}" 
                 data-severity="{{ finding.severity|lower }}"
                 data-search="{{ finding.title|lower }} {{ finding.description|lower }}">
                <div class="finding-detail-header">
                    <div class="finding-title-section">
                        <h3>{{ finding.title }}</h3>
                        <div class="finding-meta">
                            <span class="finding-id">ID: {{ finding.id }}</span>
                            <span class="finding-rule">Rule: {{ finding.rule_name }}</span>
                            <span class="finding-category">Category: {{ finding.category }}</span>
                        </div>
                    </div>
                    <div class="finding-severity-section">
                        <span class="severity-badge large {{ finding.severity|lower }}">
                            {{ finding.severity }}
                        </span>
                    </div>
                </div>
                
                <div class="finding-detail-content">
                    <div class="finding-description">
                        <h4>Description</h4>
                        <p>{{ finding.description }}</p>
                    </div>
                    
                    {% if finding.context %}
                    <div class="finding-context">
                        <h4>Context</h4>
                        <pre><code>{{ finding.context|json }}</code></pre>
                    </div>
                    {% endif %}
                    
                    {% if finding.ai_explanation and include_ai_explanations %}
                    <div class="finding-ai-explanation">
                        <h4><i class="fas fa-robot"></i> AI Explanation</h4>
                        <div class="ai-explanation-content">
                            {{ finding.ai_explanation }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if finding.recommendations %}
                    <div class="finding-recommendations">
                        <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
                        <ul>
                            {% for recommendation in finding.recommendations %}
                            <li>{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="finding-footer">
                        <div class="finding-status">
                            <span class="status-badge {{ finding.status|lower }}">
                                {{ finding.status }}
                            </span>
                        </div>
                        {% if finding.created_at %}
                        <div class="finding-timestamp">
                            <i class="far fa-clock"></i>
                            {{ finding.created_at }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-findings">
                <i class="fas fa-check-circle"></i>
                <h3>No Findings Detected</h3>
                <p>The audit completed successfully with no issues found.</p>
            </div>
            {% endfor %}
        </div>
        
        <div class="findings-summary-footer">
            <p>Total Findings: {{ report.findings|length }}</p>
        </div>
    </section>
    
    {% if report.recommendations %}
    <!-- Recommendations -->
    <section id="recommendations" class="recommendations">
        <h2><i class="fas fa-tasks"></i> Recommendations</h2>
        
        <div class="recommendations-grid">
            {% for recommendation in report.recommendations %}
            <div class="recommendation-card {{ recommendation.priority|lower }}">
                <div class="recommendation-header">
                    <h3>{{ recommendation.title }}</h3>
                    <span class="priority-badge {{ recommendation.priority|lower }}">
                        {{ recommendation.priority }}
                    </span>
                </div>
                
                <div class="recommendation-content">
                    {% if recommendation.description %}
                    <p class="recommendation-description">{{ recommendation.description }}</p>
                    {% endif %}
                    
                    {% if recommendation.actions %}
                    <div class="recommendation-actions">
                        <h4>Actions</h4>
                        <ul>
                            {% for action in recommendation.actions %}
                            <li>{{ action }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="recommendation-meta">
                        <div class="meta-item">
                            <i class="far fa-clock"></i>
                            <span>Timeline: {{ recommendation.timeline }}</span>
                        </div>
                        {% if recommendation.owner %}
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>Owner: {{ recommendation.owner }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    {% if report.appendix %}
    <!-- Appendix -->
    <section id="appendix" class="appendix">
        <h2><i class="fas fa-paperclip"></i> Appendix</h2>
        
        {% for section, content in report.appendix.items() %}
        <div class="appendix-section">
            <h3>{{ section }}</h3>
            
            {% if content is string %}
            <div class="appendix-text">{{ content }}</div>
            {% elif content is iterable %}
            <ul class="appendix-list">
                {% for item in content %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <pre class="appendix-code"><code>{{ content|json }}</code></pre>
            {% endif %}
        </div>
        {% endfor %}
    </section>
    {% endif %}
</div>

<!-- Back to Top Button -->
<button id="backToTop" class="back-to-top">
    <i class="fas fa-arrow-up"></i>
</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Severity Chart
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        const severityChart = new Chart(severityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [
                        {{ report.metrics.critical }},
                        {{ report.metrics.high }},
                        {{ report.metrics.medium }},
                        {{ report.metrics.low }}
                    ],
                    backgroundColor: [
                        '#E74C3C', // Critical
                        '#E67E22', // High
                        '#F1C40F', // Medium
                        '#2ECC71'  // Low
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Timeline Chart (example data)
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Findings',
                    data: [12, 19, 15, 25, 22, 30],
                    borderColor: '#3498DB',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Findings'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
        
        // Filter findings by severity
        const severityFilter = document.getElementById('severityFilter');
        severityFilter.addEventListener('change', function() {
            const selectedSeverity = this.value;
            const findingCards = document.querySelectorAll('.finding-detail-card');
            
            findingCards.forEach(card => {
                if (selectedSeverity === 'all' || card.dataset.severity === selectedSeverity) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        // Search findings
        const searchInput = document.getElementById('findingSearch');
        const clearSearchBtn = document.getElementById('clearSearch');
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const findingCards = document.querySelectorAll('.finding-detail-card');
            
            findingCards.forEach(card => {
                const searchableText = card.dataset.search;
                if (searchableText.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
        });
        
        // Back to top button
        const backToTopBtn = document.getElementById('backToTop');
        
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                backToTopBtn.style.display = 'block';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Expand/collapse finding details
        document.querySelectorAll('.finding-detail-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                content.classList.toggle('expanded');
            });
        });
    });
</script>
{% endblock %}
